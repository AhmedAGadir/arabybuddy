# ArabyBuddy - Coding Agent Rules

You are an expert React Native/Expo developer working on ArabyBuddy, a cross-platform language learning app that teaches Arabic dialects through fun and immersive activities.

---

## Table of Contents

- [Related Documents](#related-documents)
- [Tech Stack](#tech-stack)
- [Project Structure](#project-structure)
- [Coding Standards](#coding-standards)
- [Testing](#testing)
- [Workflow](#workflow)

---

## Related Documents

- `docs/Overview.md` - App overview, features, branding
- `docs/MVP.md` - Detailed MVP implementation tracking
- `docs/PostMVP.md` - Post-MVP features and roadmap
- `docs/Backlog.md` - Technical debt tracking

---

## Tech Stack

### Core

- **Framework:** Expo React Native
- **Language:** TypeScript (strict mode)
- **Routing:** Expo Router (file-based)
- **Styling:** NativeWind (Tailwind) + Gluestack UI

### 3D & Animation

- **3D Rendering:** Three.js via react-three-fiber
- **State Machines:** XState (character animations)
- **UI Animation:** react-native-reanimated
- **Celebrations:** react-native-fiesta

### State & Data

- **Server State:** TanStack Query
- **Validation:** Zod
- **Forms:** React Hook Form + Zod resolver

### Backend

- **Database:** Supabase Postgres
- **Auth:** Supabase Auth
- **Functions:** Supabase Edge Functions (Deno)
- **Storage:** Supabase Storage

### AI Services

- **Speech-to-Text:** OpenAI Whisper (`whisper-1`)
- **Evaluation:** OpenAI Chat (`gpt-4o`) TODO: subject to change

### Monetization

- **Subscriptions:** RevenueCat

### DevOps & Infrastructure

| Category | Service |
|----------|---------|
| **CI/CD** | EAS Build + GitHub Actions |
| **Error Tracking** | Sentry |
| **Analytics** | Mixpanel / PostHog |
| **Secrets** | Edge Functions env vars |

### MCP Servers

| Server | Purpose |
|--------|---------|
| Supabase MCP | Database, migrations, Edge Functions |
| Expo MCP | Build, preview, device testing |
| Gluestack MCP | Component documentation |
| RevenueCat MCP | Subscription management |

---

## Project Structure

We use **feature-based architecture** with **thin routes**. Route files in `app/` are one-line re-exports; all business logic lives in `features/`.

```
arabybuddy/
├── app/                        # EXPO ROUTER - Thin routes only
│   ├── _layout.tsx             # Root layout (providers only)
│   ├── login.tsx               # → export { LoginScreen } from '@/features/auth'
│   └── (tabs)/
│       ├── _layout.tsx         # Tab navigator config
│       └── index.tsx           # → export { HomeScreen } from '@/features/lessons'
│
├── features/                   # FEATURE MODULES - All business logic
│   ├── auth/
│   │   ├── components/         # Feature-specific components
│   │   ├── screens/            # Screen components
│   │   ├── hooks/              # Feature hooks
│   │   ├── services/           # API/business logic
│   │   ├── validation/         # Zod schemas
│   │   └── index.ts            # Public API barrel
│   ├── lessons/
│   ├── account/
│   ├── games/
│   ├── onboarding/
│   └── subscriptions/
│
├── shared/                     # Cross-cutting concerns
│   ├── components/             # Shared components
│   ├── hooks/
│   ├── lib/                    # supabase.ts, queryClient.ts
│   ├── constants/
│   ├── types/                  # database.types.ts (generated)
│   ├── utils/
│   └── testing/                # Test infrastructure
│
├── components/ui/              # Gluestack UI components
├── assets/
├── supabase/migrations/
├── .maestro/flows/             # E2E tests
└── docs/project-management/
```

### Key Principles

1. **Thin Routes**: Route files are one-line re-exports only
2. **No Business Logic in `app/`**: All logic in `features/` or `shared/`
3. **Feature Encapsulation**: Each feature exports via `index.ts`
4. **Colocated Tests**: Test files live next to source files
5. **Shared Only When Cross-Cutting**: Don't over-abstract

### File Naming

| Type | Convention | Example |
|------|------------|---------|
| Components | PascalCase | `LoginScreen.tsx` |
| Hooks | `use` prefix | `useAuthContext.tsx` |
| Services | `Service` suffix | `authService.ts` |
| Validation | `Schemas` suffix | `authSchemas.ts` |

---

## Coding Standards

### TypeScript

- Strict mode enabled
- Explicit return types on exported functions
- Prefer `unknown` over `any`

### Styling

**Use Gluestack UI components**

**Styling rules:**
- Use `className` with NativeWind/Tailwind classes
- Use semantic theme colors (`bg-primary-500`, `text-error-600`)
- Avoid using `StyleSheet.create()` or hardcoded hex colors if possible
- Inline `style={{}}` only for native 3rd-party components

### Arabic Content

- Body text: Tajawal font
- Headings: DGBebo font

### State Management

- Server state: TanStack Query
- Animation/flow state: XState
- Form state: React Hook Form
- Never duplicate server state locally

### Error Handling

- Use error boundaries for component trees
- Handle API errors in service layer
- Display user-friendly error messages
- Log errors to Sentry in production

### Security

- Never expose API keys client-side
- Validate all input with Zod (client + server)
- Use Supabase Auth for all auth flows
- Never log sensitive data

### Platform Support

- Code must work on iOS, Android, and Web

---

## Testing

We follow the testing pyramid with **colocated tests**:

### Unit Tests (Jest + RNTL)

- Utilities, hooks, Zod schemas
- Tests live next to source: `authService.ts` → `authService.test.ts`

### Component Tests (RNTL)

- Rendering, interactions, accessibility

### E2E Tests (Maestro)

- Critical user flows (auth, lessons, purchases)
- Organized by feature in `.maestro/flows/`

### Commands

```bash
npm run test          # Unit + component tests
npm run test:e2e      # Maestro E2E tests
npm run test:coverage # Coverage report
```

---

## Workflow

### Before Starting

1. Read `Overview.md` for product context
2. Check `MVP.md` for current status
3. Write tests ahead of code when suitable

### During Development

1. Follow feature-based architecture
2. Use Gluestack UI components
3. Validate inputs with Zod schemas
4. Export only necessary items from `index.ts`

### After Completing

1. Run `npm run lint` and fix errors
2. Run `npm run typecheck` and fix errors
3. Run `npm run test` and fix failures
4. Update `MVP.md` if completing a tracked item
5. Run `npm run database:types` if schema changed

### Updating Documentation

- Update Table of Contents if present
- THIS FILE MUST BE KEPT IN SYNC WITH CLAUDE.md
